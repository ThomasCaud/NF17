<?php

include_once '../app/Connexion.php';
include_once '../app/Entity/Exploitation.php';
include_once '../app/Form.php';

$pdo = Connexion::getConnexion();
$errors = false;

//Récupération des parcelles
$sql = "select * from parcelle";
$query = $pdo->query($sql);
$parcelle_noms = $query->fetchAll();

//Pour récupérer enum: select enum_range(NULL::EmodeCulture);
$sql = "select enum_range(NULL::EmodeCulture);";

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $exploitation = $_POST['exploitation'];
    $form = new Form($exploitation);
    $form->constraints('annee', ['required' => true]);

    if (Exploitation::get(['annee' => '2016', 'parcelle_nom' => 'P-02'])) {
        $errors[] = "L'exploitation ".$exploitation['parcelle_nom']." existe déjà pour l'année" . $exploitation['annee'];
    }

    if(!$errors){
        $sth = $pdo->prepare('INSERT INTO exploitation(parcelle_nom, annee, modeculture) VALUES (:parcelle_nom, :annee, :modeculture)');
        try {
            $pdo->beginTransaction();
            $sth->execute([
            	'parcelle_nom' => $exploitation['parcelle_nom'],
            	'annee' => $exploitation['annee'],
            	'modeculture' => $exploitation['modeculture']
            	]);
            $pdo->commit();

            redirectTo("exploitation/list");

        } catch(PDOException $e) {
            $pdo->rollback();
            $errors[] = "Erreur interne de la BDD";
        }
    }
}

return [
    'parcelle_noms' => $parcelle_noms,
    'errors'    => $errors
];

?>
